const{hooks,isPromise}=require("@feathersjs/commons"),baseHooks=require("./base"),{createHookObject,getHooks,processHooks,enableHooks,ACTIVATE_HOOKS}=hooks,withHooks=function({app:s,service:n,method:a,original:i}){return(t={})=>{const r=s.hookTypes.reduce((e,o)=>{var r=t[o]||[];return e[o]=Array.isArray(r)?r:[r],e},{});return function(...e){const o=!0===e[e.length-1]&&e.pop();e=createHookObject(a,{type:"before",arguments:e,service:n,app:s});return Promise.resolve(e).then(e=>processHooks.call(n,baseHooks.concat(r.before),e)).then(t=>{if(void 0!==t.result)return t;const e=new Promise(e=>{const o=i||n[a];var r=n.methods[a].map(e=>t[e]),r=o.apply(n,r);if(!isPromise(r))throw new Error(`Service method '${t.method}' for '${t.path}' service must return a promise`);e(r)});return e.then(e=>(t.result=e,t)).catch(e=>{throw e.hook=t,e})}).then(e=>{e=Object.assign({},e,{type:"after"});return processHooks.call(n,r.after,e)}).catch(e=>{e=Object.assign({},e.hook,{type:"error",original:e.hook,error:e,result:void 0});return processHooks.call(n,r.error,e).catch(e=>{return Object.assign({},e.hook,{error:e,result:void 0})})}).then(e=>processHooks.call(n,r.finally,e).catch(e=>{return Object.assign({},e.hook,{error:e,result:void 0})})).then(e=>void 0!==e.error&&void 0===e.result?Promise.reject(o?e:e.error):o?e:e.result)}}},hookMixin=exports.hookMixin=function(r){if("function"!=typeof r.hooks){r.methods=Object.getOwnPropertyNames(r).filter(e=>"function"==typeof r[e]&&r[e][ACTIVATE_HOOKS]).reduce((e,o)=>(e[o]=r[o][ACTIVATE_HOOKS],e),r.methods||{}),Object.assign(r.methods,{find:["params"],get:["id","params"],create:["data","params"],update:["id","data","params"],patch:["id","data","params"],remove:["id","params"]});const s=this,o=Object.keys(r.methods);var e=o.reduce((e,t)=>("function"!=typeof r[t]||(e[t]=function(){var e=this,o=Array.from(arguments),r=e._super.bind(e);return withHooks({app:s,service:e,method:t,original:r})({before:getHooks(s,e,"before",t),after:getHooks(s,e,"after",t,!0),error:getHooks(s,e,"error",t,!0),finally:getHooks(s,e,"finally",t,!0)})(...o)}),e),{});enableHooks(r,o,s.hookTypes),r.mixin(e)}};module.exports=function(){return function(e){Object.assign(e,{hookTypes:["before","after","error","finally"]}),enableHooks(e,e.methods,e.hookTypes),e.mixins.push(hookMixin)}},module.exports.withHooks=withHooks,module.exports.ACTIVATE_HOOKS=ACTIVATE_HOOKS,module.exports.activateHooks=function(o){return e=>(Object.defineProperty(e,ACTIVATE_HOOKS,{value:o}),e)};